[package]
name = "wrd-server"
version = "0.1.0"
edition = "2021"
authors = ["WRD-Server Contributors"]
description = "Wayland Remote Desktop Server using RDP protocol"
license = "MIT OR Apache-2.0"
repository = "https://github.com/lamco-admin/wayland-rdp"

[[bin]]
name = "wrd-server"
path = "src/main.rs"

[lib]
name = "wrd_server"
path = "src/lib.rs"

[dependencies]
# Async runtime
tokio = { version = "1.35", features = ["full"] }
tokio-util = { version = "0.7", features = ["codec"] }
futures = "0.3"

# Configuration and CLI
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"
toml = "0.8"
clap = { version = "4.4", features = ["derive", "env"] }

# Logging and tracing
tracing = "0.1"
tracing-subscriber = { version = "0.3", features = ["env-filter", "json", "fmt"] }
tracing-appender = "0.2"

# Error handling
anyhow = "1.0"
thiserror = "1.0"

# Networking and protocols
bytes = "1.5"
# Note: rustls and tokio-rustls provided by ironrdp-server (v0.23)
rustls-pemfile = "2.2" # Updated to match rustls 0.23

# RDP protocol
# Using glamberson/IronRDP fork - Clean fork from Devolutions/IronRDP master
# Branch: from-devolutions-clean = Devolutions master + ONLY server clipboard patch
# Clipboard fix: Servers bypass client state machine to announce clipboard ownership (CB_FORMAT_LIST)
ironrdp = { git = "https://github.com/glamberson/IronRDP", branch = "from-devolutions-clean", default-features = false, features = ["server"] }
ironrdp-server = { git = "https://github.com/glamberson/IronRDP", branch = "from-devolutions-clean" }
ironrdp-tokio = { git = "https://github.com/glamberson/IronRDP", branch = "from-devolutions-clean", features = ["reqwest"] }
ironrdp-pdu = { git = "https://github.com/glamberson/IronRDP", branch = "from-devolutions-clean" }
ironrdp-displaycontrol = { git = "https://github.com/glamberson/IronRDP", branch = "from-devolutions-clean" }
ironrdp-cliprdr = { git = "https://github.com/glamberson/IronRDP", branch = "from-devolutions-clean" }
ironrdp-core = { git = "https://github.com/glamberson/IronRDP", branch = "from-devolutions-clean" }
async-trait = "0.1"

# Video encoding
# Note: These will be added when video encoding is implemented

# Wayland and Portal integration (client-side for existing mode)
wayland-client = { version = "0.31", optional = true }
wayland-protocols = { version = "0.31", features = ["client"], optional = true }
ashpd = { version = "0.12.0", features = ["tokio"] }
zbus = "4.0.1"
enumflags2 = "0.7"

# Smithay compositor framework (server-side for headless mode)
# Note: Using basic features for now, full Smithay integration pending
smithay = { version = "0.3", default-features = false, optional = true }
wayland-server = { version = "0.31", optional = true }
wayland-protocols-wlr = { version = "0.2", optional = true }
wayland-protocols-misc = { version = "0.2", optional = true }

# Event loop for compositor
calloop = { version = "0.13", optional = true }

# TODO: Additional rendering dependencies when implementing rendering
# pixman = { version = "0.1", optional = true }
# gbm = { version = "0.14", optional = true }
# drm = { version = "0.12", optional = true }
# input = { version = "0.9", optional = true }

# PipeWire integration
pipewire = "0.8"
libspa = "0.8"
libspa-sys = "0.8"

# Input handling
# libei is not yet available on crates.io
xkbcommon = "0.7"

# Clipboard and image processing
image = { version = "0.24", features = ["png", "jpeg", "bmp"] }
percent-encoding = "2.3"
sha2 = "0.10"
# Clipboard via Portal API (delayed rendering)
futures-util = "0.3"  # For Portal signal streams

# System and utilities
nix = { version = "0.27", features = ["signal", "process", "mman"] }
libc = "0.2"
chrono = "0.4"
uuid = { version = "1.6", features = ["v4", "serde"] }
sysinfo = "0.30"

# Memory management
memmap2 = "0.9"
crossbeam-channel = "0.5"
parking_lot = "0.12"

# Certificate generation
rcgen = "0.12"
time = { version = "0.3", features = ["formatting", "macros"] }

# Authentication (optional, for PAM support)
pam = { version = "0.7", optional = true }

# Headless compositor support (Smithay)
smithay = { version = "0.3", optional = true }
smithay-client-toolkit = { version = "0.18", optional = true }

# Systemd integration for session management
sd-notify = { version = "0.4", optional = true }
systemd = { version = "0.10", optional = true }

# User/group management
users = "0.11"
uzers = "0.12"

# Process and resource management
procfs = { version = "0.16", optional = true }

# DRM/KMS for headless rendering
drm = { version = "0.11", optional = true }
gbm = { version = "0.14", optional = true }

# EGL for OpenGL ES rendering in headless mode
glutin = { version = "0.31", optional = true }

# Additional graphics support
gl = { version = "0.14", optional = true }
glow = { version = "0.13", optional = true }

[dev-dependencies]
# Testing
criterion = { version = "0.5", features = ["html_reports"] }
mockall = "0.12"
tempfile = "3.8"
proptest = "1.4"

[features]
default = ["pam-auth"]
wayland = ["wayland-client", "wayland-protocols"]
pam-auth = ["pam"]
headless-compositor = [
    "smithay",
    "wayland-server",
    "wayland-protocols-wlr",
    "wayland-protocols-misc",
    "calloop",
]
headless = ["smithay", "smithay-client-toolkit", "drm", "gbm", "glutin", "gl", "glow"]
systemd-integration = ["sd-notify", "systemd"]
resource-management = ["procfs"]
full-headless = ["headless", "systemd-integration", "resource-management", "pam-auth"]

[profile.release]
opt-level = 3
lto = true
codegen-units = 1
strip = true

[profile.dev]
opt-level = 0
debug = true

[[bench]]
name = "video_encoding"
harness = false

[[bench]]
name = "network_throughput"
harness = false
