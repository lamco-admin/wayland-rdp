[package]
name = "lamco-rdp-server"
version = "0.1.0"
edition = "2021"
rust-version = "1.77"
authors = ["Lamco <contact@lamco.ai>"]
description = "Wayland RDP server - Portal mode for Linux desktop sharing"
license = "BUSL-1.1"
repository = "https://github.com/lamco-admin/lamco-rdp-server"
homepage = "https://lamco.ai"
keywords = ["rdp", "wayland", "remote-desktop", "linux", "screen-sharing"]
categories = ["network-programming", "multimedia"]

[[bin]]
name = "lamco-rdp-server"
path = "src/main.rs"

[lib]
name = "lamco_rdp_server"
path = "src/lib.rs"

# =============================================================================
# Dependencies
# =============================================================================

[dependencies]
# -----------------------------------------------------------------------------
# Lamco crates (published to crates.io)
# -----------------------------------------------------------------------------
lamco-wayland = "0.1"         # Meta: portal + pipewire + video
lamco-rdp = "0.1"             # Meta: input + clipboard
lamco-portal = { version = "0.2", features = ["dbus-clipboard"] }  # XDG Portal + D-Bus fallback
lamco-pipewire = "0.1"        # PipeWire screen capture
lamco-video = "0.1"           # Video frame processing
lamco-rdp-input = "0.1"       # Input event translation
lamco-clipboard-core = { version = "0.2", features = ["image"] }   # Clipboard + image conversion
lamco-rdp-clipboard = "0.2"   # IronRDP clipboard integration

# -----------------------------------------------------------------------------
# Async runtime
# -----------------------------------------------------------------------------
tokio = { version = "1.35", features = ["full"] }
tokio-util = { version = "0.7", features = ["codec"] }
futures = "0.3"
futures-util = "0.3"
async-trait = "0.1"

# -----------------------------------------------------------------------------
# Configuration and CLI
# -----------------------------------------------------------------------------
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"
toml = "0.8"
clap = { version = "4.4", features = ["derive", "env"] }

# -----------------------------------------------------------------------------
# Logging and tracing
# -----------------------------------------------------------------------------
tracing = "0.1"
tracing-subscriber = { version = "0.3", features = ["env-filter", "json", "fmt"] }
tracing-appender = "0.2"

# -----------------------------------------------------------------------------
# Error handling
# -----------------------------------------------------------------------------
anyhow = "1.0"
thiserror = "2"

# -----------------------------------------------------------------------------
# Networking and protocols
# -----------------------------------------------------------------------------
bytes = "1.5"
rustls-pemfile = "2.2"

# -----------------------------------------------------------------------------
# RDP protocol (IronRDP from master - not yet published to crates.io)
# -----------------------------------------------------------------------------
ironrdp = { git = "https://github.com/Devolutions/IronRDP", branch = "master", default-features = false, features = ["server"] }
ironrdp-server = { git = "https://github.com/Devolutions/IronRDP", branch = "master" }
ironrdp-tokio = { git = "https://github.com/Devolutions/IronRDP", branch = "master", features = ["reqwest"] }
ironrdp-pdu = { git = "https://github.com/Devolutions/IronRDP", branch = "master" }
ironrdp-displaycontrol = { git = "https://github.com/Devolutions/IronRDP", branch = "master" }
ironrdp-cliprdr = { git = "https://github.com/Devolutions/IronRDP", branch = "master" }
ironrdp-core = { git = "https://github.com/Devolutions/IronRDP", branch = "master" }
ironrdp-dvc = { git = "https://github.com/Devolutions/IronRDP", branch = "master" }
ironrdp-svc = { git = "https://github.com/Devolutions/IronRDP", branch = "master" }

# -----------------------------------------------------------------------------
# Wayland and Portal integration
# -----------------------------------------------------------------------------
wayland-client = { version = "0.31", optional = true }
wayland-protocols = { version = "0.31", features = ["client"], optional = true }
ashpd = { version = "0.12.0", features = ["tokio"] }
zbus = "4.0.1"
enumflags2 = "0.7"

# -----------------------------------------------------------------------------
# PipeWire integration
# -----------------------------------------------------------------------------
pipewire = "0.8"
libspa = "0.8"
libspa-sys = "0.8"

# -----------------------------------------------------------------------------
# Input handling
# -----------------------------------------------------------------------------
xkbcommon = "0.7"

# -----------------------------------------------------------------------------
# Image processing
# -----------------------------------------------------------------------------
image = { version = "0.25", default-features = false, features = ["png", "jpeg", "bmp"] }
percent-encoding = "2.3"
sha2 = "0.10"

# -----------------------------------------------------------------------------
# H.264 encoding (optional, for EGFX)
# -----------------------------------------------------------------------------
openh264 = { version = "0.6", optional = true }

# -----------------------------------------------------------------------------
# System and utilities
# -----------------------------------------------------------------------------
nix = { version = "0.27", features = ["signal", "process", "mman"] }
libc = "0.2"
chrono = "0.4"
uuid = { version = "1.6", features = ["v4", "serde"] }
sysinfo = "0.30"

# -----------------------------------------------------------------------------
# Memory management
# -----------------------------------------------------------------------------
memmap2 = "0.9"
crossbeam-channel = "0.5"
parking_lot = "0.12"

# -----------------------------------------------------------------------------
# Certificate generation
# -----------------------------------------------------------------------------
rcgen = "0.12"
time = { version = "0.3", features = ["formatting", "macros"] }

# -----------------------------------------------------------------------------
# Authentication (optional)
# -----------------------------------------------------------------------------
pam = { version = "0.7", optional = true }

# =============================================================================
# Dev Dependencies
# =============================================================================

[dev-dependencies]
criterion = { version = "0.5", features = ["html_reports"] }
mockall = "0.12"
tempfile = "3.8"
proptest = "1.4"

# =============================================================================
# Features
# =============================================================================

[features]
default = ["pam-auth"]
wayland = ["wayland-client", "wayland-protocols"]
pam-auth = ["pam"]

# H.264 video encoding via EGFX channel
# Requires OpenH264 (BSD licensed, source bundled)
# For best performance, ensure `nasm` is installed (3x speedup)
h264 = ["openh264"]

# Future features (not yet implemented)
# multimon = []       # Multi-monitor support

# =============================================================================
# Profiles
# =============================================================================

[profile.release]
opt-level = 3
lto = true
codegen-units = 1
strip = true

[profile.dev]
opt-level = 0
debug = true

# =============================================================================
# Lints
# =============================================================================

[lints.rust]
unsafe_code = "warn"
unsafe_op_in_unsafe_fn = "warn"
elided_lifetimes_in_paths = "warn"
unreachable_pub = "warn"

[lints.clippy]
wildcard_imports = "warn"
large_futures = "warn"

# Relaxed for coordinate/graphics code
as_conversions = "allow"
cast_lossless = "allow"
cast_possible_truncation = "allow"
cast_possible_wrap = "allow"

# =============================================================================
# Patches - Override transitive dependencies
# =============================================================================
#
# The published lamco-* crates depend on IronRDP 0.5.0 (last published version).
# We need features from git master, so we patch ALL IronRDP crates to use
# the same git source. This ensures consistency across the entire dependency tree.
#
# When Devolutions publishes a new IronRDP version, we can:
# 1. Update lamco crates to use the new version
# 2. Remove this [patch] section
# =============================================================================

[patch.crates-io]
ironrdp = { git = "https://github.com/Devolutions/IronRDP", branch = "master" }
ironrdp-pdu = { git = "https://github.com/Devolutions/IronRDP", branch = "master" }
ironrdp-server = { git = "https://github.com/Devolutions/IronRDP", branch = "master" }
ironrdp-graphics = { git = "https://github.com/Devolutions/IronRDP", branch = "master" }
ironrdp-cliprdr = { git = "https://github.com/Devolutions/IronRDP", branch = "master" }
ironrdp-svc = { git = "https://github.com/Devolutions/IronRDP", branch = "master" }
ironrdp-dvc = { git = "https://github.com/Devolutions/IronRDP", branch = "master" }
ironrdp-core = { git = "https://github.com/Devolutions/IronRDP", branch = "master" }
ironrdp-tokio = { git = "https://github.com/Devolutions/IronRDP", branch = "master" }
ironrdp-displaycontrol = { git = "https://github.com/Devolutions/IronRDP", branch = "master" }

