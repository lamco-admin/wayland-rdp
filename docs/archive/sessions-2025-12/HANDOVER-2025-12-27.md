# Comprehensive Project Handover Document

**Date:** 2025-12-27
**Project:** lamco-rdp-server (Wayland RDP Server)
**Status:** Active Development - Premium Features Complete, Quality Refinement Phase

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Repository Landscape](#2-repository-landscape)
3. [Architecture Overview](#3-architecture-overview)
4. [Current Implementation Status](#4-current-implementation-status)
5. [Recent Work Completed](#5-recent-work-completed)
6. [Known Issues and Technical Debt](#6-known-issues-and-technical-debt)
7. [Pending Upstream Contributions](#7-pending-upstream-contributions)
8. [Color Space Infrastructure](#8-color-space-infrastructure)
9. [NVENC Critical Implementation Details](#9-nvenc-critical-implementation-details)
10. [Build and Deployment](#10-build-and-deployment)
11. [Testing Infrastructure](#11-testing-infrastructure)
12. [Suggested Next Steps](#12-suggested-next-steps)
13. [Key Files Reference](#13-key-files-reference)

---

## 1. Executive Summary

### What This Is

**lamco-rdp-server** is a Wayland-native RDP server for Linux that enables remote desktop access using the XDG Desktop Portal and PipeWire for screen capture. It implements the Microsoft RDP protocol with:

- **H.264 video encoding** via EGFX (Graphics Pipeline Extension)
- **Hardware acceleration** via VA-API (Intel/AMD) and NVENC (NVIDIA)
- **Bidirectional clipboard** with text, images, and file transfer
- **Multi-monitor support** with dynamic resolution

### Business Model

- **Open Source Core** - Basic RDP functionality
- **Premium Features** - AVC444 (YUV444 encoding), hardware acceleration, damage tracking

### Current State

| Component | Status | Notes |
|-----------|--------|-------|
| Core RDP Protocol | ✅ Production Ready | Stable connections, all standard channels |
| H.264 Software (OpenH264) | ✅ Working | AVC420 and AVC444 modes |
| VA-API Hardware | ✅ Working | Intel/AMD GPU encoding |
| NVENC Hardware | ✅ Fixed | Move-invalidation bug resolved |
| Clipboard (Text) | ✅ Working | Bidirectional with RTF support |
| Clipboard (Files) | ⚠️ In Progress | Server→client works, client→server pending |
| Color Space | ⚠️ Needs Work | Mismatch causing visual artifacts |
| Damage Tracking | ✅ Implemented | SIMD-optimized (AVX2/NEON) |

---

## 2. Repository Landscape

The project spans **four related repositories** on the local development machine:

### 2.1 wrd-server-specs (Main Server)

**Location:** `/home/greg/wayland/wrd-server-specs`
**Purpose:** The main RDP server application
**License:** BUSL-1.1 (Business Source License)

```
wrd-server-specs/
├── src/
│   ├── main.rs              # Entry point
│   ├── lib.rs               # Public API and re-exports
│   ├── config/              # TOML configuration
│   ├── server/              # Core server logic
│   │   ├── mod.rs           # Server orchestration
│   │   ├── event_multiplexer.rs  # Async event loop
│   │   ├── display_handler.rs    # Video frame processing
│   │   ├── input_handler.rs      # Keyboard/mouse
│   │   └── gfx_factory.rs        # Encoder factory
│   ├── egfx/                # EGFX video encoding
│   │   ├── mod.rs           # EGFX channel handler
│   │   ├── encoder.rs       # OpenH264 wrapper
│   │   ├── avc444_encoder.rs    # AVC444 dual-stream
│   │   ├── color_space.rs   # NEW: VUI color configuration
│   │   ├── color_convert.rs # BGRA→YUV with SIMD
│   │   ├── yuv444_packing.rs    # AVC444 stream packing
│   │   └── hardware/        # Hardware encoders
│   │       ├── nvenc/mod.rs # NVIDIA NVENC
│   │       └── vaapi/mod.rs # VA-API (Intel/AMD)
│   ├── clipboard/           # Clipboard orchestration
│   ├── damage/              # Tile-based damage detection
│   ├── multimon/            # Multi-monitor support
│   └── security/            # TLS and authentication
├── docs/                    # Extensive documentation
├── examples/                # Integration examples
└── benches/                 # Performance benchmarks
```

### 2.2 lamco-rdp-workspace (Published Crates)

**Location:** `/home/greg/wayland/lamco-rdp-workspace`
**Purpose:** Reusable library crates published to crates.io
**License:** MIT/Apache-2.0

| Crate | Version | Purpose |
|-------|---------|---------|
| `lamco-rdp` | 0.4.0 | Meta-crate with feature flags |
| `lamco-portal` | 0.2.2 | XDG Desktop Portal integration |
| `lamco-pipewire` | 0.1.x | PipeWire screen capture (local path - fix pending) |
| `lamco-video` | 0.1.2 | Video frame processing |
| `lamco-rdp-input` | 0.1.1 | uinput keyboard/mouse |
| `lamco-clipboard-core` | 0.4.0 | Clipboard abstraction |
| `lamco-rdp-clipboard` | latest | RDP CLIPRDR channel (local path - trait coupling) |

**Note:** Two crates use local paths instead of crates.io versions:
- `lamco-pipewire`: Has unfixed zero-size buffer bug (see Issue #1 below)
- `lamco-rdp-clipboard`: Tightly coupled to IronRDP fork for trait compatibility

### 2.3 IronRDP (Local Fork)

**Location:** `/home/greg/wayland/IronRDP`
**Upstream:** `https://github.com/Devolutions/IronRDP`
**Fork:** `https://github.com/glamberson/IronRDP`
**Branch:** `combined-egfx-file-transfer`

This fork includes features not yet merged upstream:

| Feature | PRs | Status |
|---------|-----|--------|
| EGFX Server Integration | #1057 | Open - awaiting review |
| ZGFX Compression Optimization | Not submitted | Local commits ready |
| Clipboard Lock/Unlock | #1064 | Open |
| Request File Contents | #1065 | Open |
| File Contents Response | #1066 | Open |
| reqwest Feature Fix | #1063 | Open |

**Recent Commits on Fork:**
```
4a5ebb5b chore(cliprdr): restore version to 0.5.0
57608dad feat(zgfx): add hash table size limits and compaction
4a93ffae fix(zgfx): prevent duplicate hash table entries causing exponential slowdown
a0eacc50 feat(zgfx): implement O(1) hash table optimization for compression
70d30654 feat(server): implement Hybrid architecture for proactive EGFX frame sending
3938b4fa feat(ironrdp-server): add EGFX (Graphics Pipeline) server integration
```

### 2.4 openh264-rs-fork (Pending)

**Location:** `/home/greg/wayland/openh264-rs-fork`
**Purpose:** Fork for adding VUI color space support
**Status:** Research complete, implementation planned

---

## 3. Architecture Overview

### 3.1 High-Level Data Flow

```
┌────────────────────────────────────────────────────────────────────┐
│                      WAYLAND COMPOSITOR                            │
│  (KDE Plasma, GNOME, Sway, etc.)                                   │
└──────────────────────┬─────────────────────────────────────────────┘
                       │
           ┌───────────┴───────────┐
           │ XDG Desktop Portal    │
           │ (org.freedesktop)     │
           └───────────┬───────────┘
                       │
     ┌─────────────────┼─────────────────┐
     │                 │                 │
     ▼                 ▼                 ▼
┌─────────┐     ┌───────────┐     ┌──────────┐
│ Remote  │     │ScreenCast│     │Clipboard │
│ Desktop │     │ (PipeWire)│     │ (Portal) │
│(uinput) │     │           │     │          │
└────┬────┘     └─────┬─────┘     └────┬─────┘
     │                │                 │
     │                │                 │
     └────────────────┼─────────────────┘
                      │
          ┌───────────┴───────────┐
          │   lamco-rdp-server    │
          │                       │
          │  ┌─────────────────┐  │
          │  │ Event Multiplex │  │
          │  │     Loop        │  │
          │  └────────┬────────┘  │
          │           │           │
          │   ┌───────┼───────┐   │
          │   │       │       │   │
          │   ▼       ▼       ▼   │
          │ Input  Video  Clipboard│
          │Handler Handler Manager│
          │   │       │       │   │
          │   └───────┼───────┘   │
          │           │           │
          │  ┌────────▼────────┐  │
          │  │   IronRDP       │  │
          │  │ Protocol Stack  │  │
          │  └────────┬────────┘  │
          └───────────┼───────────┘
                      │
                      ▼
          ┌───────────────────────┐
          │    RDP CLIENT         │
          │ (Windows, FreeRDP)    │
          └───────────────────────┘
```

### 3.2 Video Encoding Pipeline

```
PipeWire Video Frame (BGRA)
         │
         ├── Damage Detection (optional)
         │   └── SIMD tile comparison (AVX2/NEON)
         │
         ├─────────────────┬─────────────────┐
         │                 │                 │
    ┌────▼────┐      ┌─────▼─────┐     ┌─────▼─────┐
    │OpenH264 │      │  VA-API   │     │  NVENC    │
    │(Software)│      │(Intel/AMD)│     │(NVIDIA)  │
    └────┬────┘      └─────┬─────┘     └─────┬─────┘
         │                 │                 │
         │    ┌────────────┴────────────┐    │
         │    │                         │    │
         ▼    ▼                         ▼    ▼
    ┌─────────────┐              ┌─────────────┐
    │   AVC420    │              │   AVC444    │
    │ (Standard)  │              │ (Premium)   │
    │ YUV 4:2:0   │              │ YUV 4:4:4   │
    └──────┬──────┘              └──────┬──────┘
           │                            │
           │                     ┌──────┴──────┐
           │                     │ Dual Stream │
           │                     │ Decompose   │
           │                     └──────┬──────┘
           │                            │
           └────────────┬───────────────┘
                        │
                        ▼
               ┌────────────────┐
               │ EGFX Channel   │
               │ (H.264 NALs)   │
               └────────┬───────┘
                        │
                        ▼
                   RDP Client
```

### 3.3 Clipboard Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                        WAYLAND                                   │
│                                                                  │
│   ┌───────────────┐                      ┌───────────────┐      │
│   │  Application  │◄────wl_data_offer───►│  Application  │      │
│   │  (Copy Src)   │                      │  (Paste Dst)  │      │
│   └───────┬───────┘                      └───────────────┘      │
│           │                                                      │
│           ▼                                                      │
│   ┌───────────────────────────────────────────────────────┐     │
│   │              XDG Desktop Portal                        │     │
│   │         (org.freedesktop.portal.Clipboard)            │     │
│   └───────────────────────────┬───────────────────────────┘     │
└───────────────────────────────┼─────────────────────────────────┘
                                │
                                ▼
                    ┌───────────────────────┐
                    │ lamco-clipboard-core  │
                    │   ClipboardContent    │
                    │   ClipboardSink trait │
                    └───────────┬───────────┘
                                │
                                ▼
                    ┌───────────────────────┐
                    │  lamco-rdp-clipboard  │
                    │   RdpCliprdrFactory   │
                    │   IronRDP Backend     │
                    └───────────┬───────────┘
                                │
                                ▼
                    ┌───────────────────────┐
                    │     ironrdp-cliprdr   │
                    │    (CLIPRDR Channel)  │
                    └───────────┬───────────┘
                                │
                                ▼
                          RDP Client
```

---

## 4. Current Implementation Status

### 4.1 Feature Completion Matrix

| Feature | AVC420 | AVC444 | Hardware | Notes |
|---------|--------|--------|----------|-------|
| Basic Encoding | ✅ | ✅ | ✅ | All codecs working |
| Color Conversion | ⚠️ | ⚠️ | ⚠️ | Mismatch issues |
| VUI Parameters | ❌ | ❌ | ❌ | Not yet implemented |
| Damage Tracking | ✅ | ✅ | ✅ | SIMD optimized |
| Multi-Monitor | ✅ | ✅ | ✅ | Dynamic surfaces |
| Frame Pacing | ✅ | ✅ | ✅ | FPS limiting |

### 4.2 Premium Features Status

| Feature | Implementation | Testing | Documentation |
|---------|---------------|---------|---------------|
| AVC444 Encoding | ✅ Complete | ✅ Tested | ✅ Documented |
| Damage Tracking | ✅ Complete | ✅ Tested | ✅ Documented |
| VA-API (Intel/AMD) | ✅ Complete | ✅ Tested | ✅ Documented |
| NVENC (NVIDIA) | ✅ Fixed | ⚠️ Limited | ✅ Documented |
| Multi-Monitor | ✅ Complete | ✅ Tested | ⚠️ Partial |

### 4.3 Test Environments

| Environment | Status | Last Test |
|-------------|--------|-----------|
| KDE Plasma 6 | ✅ Works | 2025-12-27 |
| GNOME 46 | ✅ Works | 2025-12-25 |
| Sway | ⚠️ Partial | Portal issues |
| Windows Client (mstsc) | ✅ Works | 2025-12-27 |
| FreeRDP Client | ✅ Works | 2025-12-25 |

---

## 5. Recent Work Completed

### 5.1 NVENC Move-Invalidation Fix (2025-12-27)

**Problem:** NVENC encoder crashed during `Drop` with `InvalidEncoderDevice` or `DeviceNotExist` errors.

**Root Cause:** The `nvidia-video-codec-sdk` types (`Session`, `Buffer`, `Bitstream`) contain internal raw pointers that become invalid when the struct is moved in memory. This happened when `NvencEncoder` was returned from a function.

**Solution:** Box all NVENC types immediately after creation to prevent moves:

```rust
pub struct NvencEncoder {
    input_buffers: Vec<Option<Box<Buffer<'static>>>>,
    output_bitstreams: Vec<Option<Box<Bitstream<'static>>>>,
    cuda_ctx: Arc<CudaContext>,
    // ... other fields ...
    session: Box<Session>,  // MUST BE LAST
}
```

**Additional Requirements:**
1. Bind CUDA context in Drop implementation
2. Drop buffers before session (field ordering + explicit None)
3. Use `&mut **buffer` to access through Box

**Documentation:** `docs/architecture/NVENC-AND-COLOR-INFRASTRUCTURE.md`

### 5.2 Color Space Infrastructure (2025-12-27)

Created comprehensive color space configuration system:

- `src/egfx/color_space.rs` - VUI parameters, color presets (BT.709, BT.601, sRGB)
- Updated `src/egfx/color_convert.rs` - Fixed-point arithmetic, SIMD optimization
- Research documents on NVENC color handling

**Key Finding:** NVENC's internal RGB→YUV conversion uses BT.601, NOT the VUI parameters. VUI is metadata only.

### 5.3 Quality Issue Analysis (2025-12-27)

Analyzed visual corruption (pink/magenta artifacts) in RDP sessions:

**Issue #1 (Critical):** Zero-size buffers from PipeWire passed through to encoder
- 82 zero-size buffers in 63-second session
- Only 29% caught by validation
- Fix required in `lamco-pipewire`

**Issue #2:** High frame drop rate (54%)
- Indicates pipeline backpressure

---

## 6. Known Issues and Technical Debt

### 6.1 Critical Issues

| Issue | Location | Impact | Priority |
|-------|----------|--------|----------|
| Zero-size buffer passthrough | `lamco-pipewire` | Visual corruption | **P0** |
| Color matrix mismatch | All encoders | Wrong colors | **P1** |
| VUI not set | OpenH264, VA-API, NVENC | Decoder confusion | **P1** |

### 6.2 Technical Debt

| Item | Description | Effort |
|------|-------------|--------|
| Local path dependencies | lamco-pipewire, lamco-rdp-clipboard | 1 day |
| IronRDP fork dependency | 5 open PRs awaiting merge | External |
| OpenH264 VUI support | Needs upstream contribution | 2 days |
| NVENC color conversion | Need CPU or CUDA YUV conversion | 2-3 days |

### 6.3 Configuration Issues

From `docs/QUALITY-ISSUE-ANALYSIS-2025-12-27.md`:

```toml
# Config says avc420 but AVC444 is active
[egfx]
codec = "avc420"
avc444_enabled = true  # This overrides codec!
```

The configuration hierarchy is confusing and should be simplified.

---

## 7. Pending Upstream Contributions

### 7.1 IronRDP PRs (5 Open)

| PR | Title | Status | Age |
|----|-------|--------|-----|
| #1057 | feat(egfx): add MS-RDPEGFX Graphics Pipeline Extension | Open | 11 days |
| #1063 | fix(server): enable reqwest feature for ironrdp-tokio | Open | 4 days |
| #1064 | feat(cliprdr): add clipboard data locking methods | Open | 4 days |
| #1065 | feat(cliprdr): add request_file_contents method | Open | 4 days |
| #1066 | feat(cliprdr): add SendFileContentsResponse message | Open | 4 days |

**Action Required:** Follow up with Devolutions maintainers on review.

### 7.2 New PRs to Submit

| PR | Description | Files | Priority |
|----|-------------|-------|----------|
| ZGFX Optimization | O(1) hash table, fix exponential slowdown | 5 files, +1500 lines | HIGH |
| Server Integration | Hybrid architecture for EGFX | 4 files, +300 lines | MEDIUM |

### 7.3 openh264-rs Contribution

**Purpose:** Add VUI color space configuration to EncoderConfig

**Status:** Research complete, maintainer is active and receptive to PRs

**Files to Modify:**
- Add VUI fields to `EncoderConfig`
- Apply in `reinit()` to `sSpatialLayers[0]`

---

## 8. Color Space Infrastructure

### 8.1 The Problem

Different encoder paths handle color conversion inconsistently:

| Encoder | Current Behavior | VUI Set? | Result |
|---------|-----------------|----------|--------|
| OpenH264 (BGRA input) | Internal BT.601 | ❌ | Unspecified |
| OpenH264 (YUVSlices) | Our BT.709 | ❌ | Mismatch |
| VA-API | Hardcoded BT.709 | Partial | Inconsistent |
| NVENC (ARGB input) | Internal BT.601 | ❌ | Wrong |

### 8.2 The Solution

See `docs/COLOR-SPACE-IMPLEMENTATION-PLAN.md` for complete details.

**Summary:**
1. Create unified `ColorSpaceConfig` struct
2. Do our own RGB→YUV conversion (control the matrix)
3. Set VUI parameters to match our conversion
4. Result: Correct colors with correct metadata

### 8.3 Implementation Files

| File | Purpose |
|------|---------|
| `src/egfx/color_space.rs` | VUI enums, ColorSpaceConfig, presets |
| `src/egfx/color_convert.rs` | BGRA→YUV444 with SIMD |
| `src/egfx/yuv444_packing.rs` | AVC444 stream decomposition |

---

## 9. NVENC Critical Implementation Details

### 9.1 The Move-Invalidation Bug

**DO NOT DO THIS:**
```rust
fn create_encoder() -> NvencEncoder {
    let session = encoder.start_session(...);
    let buffer = session.create_input_buffer();
    NvencEncoder { session, buffer }  // CRASH - move invalidates pointers
}
```

**DO THIS:**
```rust
fn create_encoder() -> NvencEncoder {
    let session = Box::new(encoder.start_session(...));
    let buffer = session.create_input_buffer();
    let buffer: Buffer<'static> = unsafe { std::mem::transmute(buffer) };
    let buffer = Box::new(buffer);
    NvencEncoder { buffer: Some(buffer), session }
}
```

### 9.2 Drop Implementation

```rust
impl Drop for NvencEncoder {
    fn drop(&mut self) {
        // 1. Bind CUDA context (thread-local!)
        self.cuda_ctx.bind_to_thread().ok();

        // 2. Drop buffers BEFORE session
        for buf in &mut self.input_buffers {
            *buf = None;
        }
        for buf in &mut self.output_bitstreams {
            *buf = None;
        }
        // 3. session drops automatically
    }
}
```

### 9.3 Field Ordering

```rust
pub struct NvencEncoder {
    // Dropped FIRST (reference session)
    input_buffers: Vec<Option<Box<Buffer<'static>>>>,
    output_bitstreams: Vec<Option<Box<Bitstream<'static>>>>,

    // Dropped SECOND
    cuda_ctx: Arc<CudaContext>,
    // ... other fields ...

    // Dropped LAST (owns encoder)
    session: Box<Session>,
}
```

### 9.4 Color Space Handling

**NVENC VUI parameters are metadata only** - they don't control the internal RGB→YUV conversion.

For accurate BT.709 encoding:
1. Convert BGRA→NV12 ourselves using BT.709 matrix
2. Feed NV12 to NVENC (no internal conversion)
3. Set VUI to BT.709

---

## 10. Build and Deployment

### 10.1 Build Requirements

```bash
# System dependencies
sudo apt install \
    libpipewire-0.3-dev \
    libspa-0.2-dev \
    libva-dev \
    nasm \
    libpam0g-dev

# For NVENC (optional)
# Requires NVIDIA driver with libnvidia-encode.so
# AND CUDA toolkit (for cudarc)

# Build
cargo build --release --features "h264,vaapi,nvenc"
```

### 10.2 Feature Flags

| Feature | Description | Dependencies |
|---------|-------------|--------------|
| `h264` | OpenH264 software encoding | nasm (optional, 3x speedup) |
| `vaapi` | Intel/AMD hardware encoding | libva-dev 1.20+ |
| `nvenc` | NVIDIA hardware encoding | CUDA toolkit, nvidia-encode |
| `pam-auth` | PAM authentication | libpam0g-dev |

### 10.3 Configuration

```toml
# /etc/lamco-rdp-server/config.toml

[server]
bind_address = "0.0.0.0:3389"
security_layer = "hybrid"

[egfx]
enabled = true
codec = "avc420"          # or "avc444" for premium
avc444_enabled = false    # Premium feature
h264_bitrate = 8000       # kbps

[hardware_encoding]
enabled = true
prefer_nvenc = true       # NVIDIA > VA-API
fallback_to_software = true

[damage_tracking]
enabled = true            # Premium feature
tile_size = 32
threshold = 5
```

---

## 11. Testing Infrastructure

### 11.1 Test Commands

```bash
# Unit tests
cargo test

# Benchmarks
cargo bench --bench video_encoding
cargo bench --bench color_conversion
cargo bench --bench damage_detection

# Integration test (requires display)
cargo run --example pipewire_capture

# NVENC test
cargo run --example nvenc_test
```

### 11.2 Manual Testing

```bash
# Start server on test machine
./target/release/lamco-rdp-server

# Connect from Windows
mstsc /v:192.168.x.x

# Connect with FreeRDP (debug output)
xfreerdp /v:192.168.x.x /log-level:DEBUG /gfx:avc444
```

### 11.3 Log Analysis

```bash
# Enable debug logging
RUST_LOG=lamco_rdp_server=debug,lamco_pipewire=debug

# Key log patterns to watch:
# - "Zero-size buffer" - PipeWire issue
# - "Stride mismatch" - Buffer corruption
# - "encode_picture failed" - Encoder error
# - "DeviceNotExist" - CUDA context issue
```

---

## 12. Suggested Next Steps

### 12.1 Immediate (This Week)

| Priority | Task | Effort |
|----------|------|--------|
| **P0** | Fix zero-size buffer passthrough in lamco-pipewire | 2 hours |
| **P0** | Publish lamco-pipewire fix to crates.io | 1 hour |
| **P1** | Submit ZGFX optimization PR to IronRDP | 2 hours |
| **P1** | Follow up on 5 open IronRDP PRs | 1 hour |

### 12.2 Short-Term (This Month)

| Priority | Task | Effort |
|----------|------|--------|
| **P1** | Implement OpenH264 VUI support (fork + upstream PR) | 2 days |
| **P1** | Fix VA-API color matrix configuration | 1 day |
| **P2** | Implement NVENC CPU color conversion | 2 days |
| **P2** | Simplify EGFX configuration hierarchy | 1 day |

### 12.3 Medium-Term

| Priority | Task | Effort |
|----------|------|--------|
| **P2** | CUDA kernel for NVENC color conversion | 3 days |
| **P2** | Complete file transfer (client→server) | 3 days |
| **P3** | Dynamic resolution change support | 2 days |
| **P3** | Audio forwarding | 1 week |

### 12.4 After IronRDP PRs Merge

1. Update `wrd-server-specs` to use upstream IronRDP
2. Update `lamco-rdp-workspace` to use crates.io
3. Remove local fork dependency
4. Publish updated lamco crates

---

## 13. Key Files Reference

### 13.1 Main Server

| File | Purpose | Lines |
|------|---------|-------|
| `src/main.rs` | Entry point, CLI parsing | ~200 |
| `src/lib.rs` | Public API, re-exports | ~160 |
| `src/server/mod.rs` | Server orchestration | ~600 |
| `src/server/event_multiplexer.rs` | Async event loop | ~400 |
| `src/server/display_handler.rs` | Video frame processing | ~500 |

### 13.2 EGFX Video Encoding

| File | Purpose | Lines |
|------|---------|-------|
| `src/egfx/mod.rs` | EGFX channel handler | ~300 |
| `src/egfx/encoder.rs` | OpenH264 wrapper | ~800 |
| `src/egfx/avc444_encoder.rs` | AVC444 dual-stream | ~400 |
| `src/egfx/color_space.rs` | VUI configuration | ~700 |
| `src/egfx/color_convert.rs` | BGRA→YUV with SIMD | ~1200 |
| `src/egfx/hardware/nvenc/mod.rs` | NVENC encoder | ~800 |
| `src/egfx/hardware/vaapi/mod.rs` | VA-API encoder | ~900 |

### 13.3 Documentation

| File | Purpose |
|------|---------|
| `docs/architecture/NVENC-AND-COLOR-INFRASTRUCTURE.md` | NVENC Box fix, color pipeline |
| `docs/COLOR-SPACE-IMPLEMENTATION-PLAN.md` | VUI implementation roadmap |
| `docs/QUALITY-ISSUE-ANALYSIS-2025-12-27.md` | Visual corruption analysis |
| `docs/OPEN-SOURCE-AND-PR-STATUS-2025-12-26.md` | Upstream PR tracking |
| `docs/research/NVENC-COLOR-SPACE-RESEARCH.md` | NVENC color handling research |

### 13.4 Configuration

| File | Purpose |
|------|---------|
| `Cargo.toml` | Dependencies, features, patches |
| `src/config/mod.rs` | Config parsing |
| `src/config/types.rs` | Config structures |

---

## Appendix: Quick Reference Commands

```bash
# Build all features
cargo build --release --features "h264,vaapi,nvenc,pam-auth"

# Run with debug logging
RUST_LOG=debug ./target/release/lamco-rdp-server

# Check IronRDP fork status
git -C /home/greg/wayland/IronRDP log --oneline -10

# Check lamco-rdp-workspace status
git -C /home/greg/wayland/lamco-rdp-workspace status

# List pending changes
git status --porcelain

# Run benchmarks
cargo bench
```

---

*Document generated 2025-12-27*
