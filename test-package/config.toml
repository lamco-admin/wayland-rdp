# =============================================================================
# lamco-rdp-server Portable Test Configuration
# =============================================================================
#
# This config uses RELATIVE PATHS - run from the test-package directory.
#
# Usage: cd /path/to/test-package && ./run-server.sh
#
# =============================================================================

# -----------------------------------------------------------------------------
# SERVER CONFIGURATION
# -----------------------------------------------------------------------------
[server]
listen_addr = "0.0.0.0:3389"
max_connections = 10
session_timeout = 0
use_portals = true

# -----------------------------------------------------------------------------
# SECURITY CONFIGURATION
# -----------------------------------------------------------------------------
[security]
# Relative paths - resolved from current working directory
cert_path = "./certs/test-cert.pem"
key_path = "./certs/test-key.pem"
enable_nla = false
auth_method = "none"
require_tls_13 = false

# -----------------------------------------------------------------------------
# VIDEO CONFIGURATION
# -----------------------------------------------------------------------------
[video]
encoder = "auto"
vaapi_device = "/dev/dri/renderD128"
target_fps = 30
bitrate = 4000
damage_tracking = true
cursor_mode = "metadata"

# -----------------------------------------------------------------------------
# VIDEO PIPELINE CONFIGURATION
# -----------------------------------------------------------------------------
[video_pipeline.processor]
target_fps = 30
max_queue_depth = 30
adaptive_quality = true
damage_threshold = 0.05
drop_on_full_queue = true
enable_metrics = true

[video_pipeline.dispatcher]
channel_size = 30
priority_dispatch = true
max_frame_age_ms = 150
enable_backpressure = true
high_water_mark = 0.8
low_water_mark = 0.5
load_balancing = true

[video_pipeline.converter]
buffer_pool_size = 8
enable_simd = true
damage_threshold = 0.75
enable_statistics = true

# -----------------------------------------------------------------------------
# INPUT CONFIGURATION
# -----------------------------------------------------------------------------
[input]
use_libei = true
keyboard_layout = "auto"
enable_touch = false

# -----------------------------------------------------------------------------
# CLIPBOARD CONFIGURATION
# -----------------------------------------------------------------------------
[clipboard]
enabled = true
max_size = 10485760
rate_limit_ms = 200
allowed_types = []

# -----------------------------------------------------------------------------
# MULTI-MONITOR CONFIGURATION
# -----------------------------------------------------------------------------
[multimon]
enabled = true
max_monitors = 4

# -----------------------------------------------------------------------------
# PERFORMANCE CONFIGURATION
# -----------------------------------------------------------------------------
[performance]
encoder_threads = 0
network_threads = 0
buffer_pool_size = 16
zero_copy = true

[performance.adaptive_fps]
enabled = true
min_fps = 5
max_fps = 30
high_activity_threshold = 0.30
medium_activity_threshold = 0.10
low_activity_threshold = 0.01

[performance.latency]
mode = "balanced"
interactive_max_delay_ms = 16
balanced_max_delay_ms = 33
quality_max_delay_ms = 100
balanced_damage_threshold = 0.02
quality_damage_threshold = 0.05

# -----------------------------------------------------------------------------
# LOGGING CONFIGURATION
# -----------------------------------------------------------------------------
[logging]
level = "debug"
metrics = true
# log_dir is set via run script

# =============================================================================
# OPTIONAL SECTIONS
# =============================================================================

[egfx]
enabled = true
h264_level = "auto"
h264_bitrate = 5000
zgfx_compression = "never"
max_frames_in_flight = 3
frame_ack_timeout = 5000
codec = "avc420"
qp_min = 10
qp_max = 40
qp_default = 23
avc444_aux_bitrate_ratio = 0.5
color_matrix = "auto"
color_range = "auto"
# AVC444 disabled by default for maximum compatibility
# Enable on newer systems (GNOME 45+, KDE 6+) after testing
avc444_enabled = false
avc444_enable_aux_omission = true
avc444_max_aux_interval = 30
avc444_aux_change_threshold = 0.05
avc444_force_aux_idr_on_return = false

[damage_tracking]
enabled = true
method = "diff"
tile_size = 64
diff_threshold = 0.05
merge_distance = 32

[hardware_encoding]
enabled = false
vaapi_device = "/dev/dri/renderD128"
enable_dmabuf_zerocopy = true
fallback_to_software = true
quality_preset = "balanced"
prefer_nvenc = true

[display]
allow_resize = true
allowed_resolutions = []
dpi_aware = false
allow_rotation = false

[advanced_video]
enable_frame_skip = true
scene_change_threshold = 0.7
intra_refresh_interval = 300
enable_adaptive_quality = false
